**@MagoPyBot - telegram bot**
* [Bot link](https://t.me/MagoPyBot)​ 

Telegram\_bot.py  
**track\_user(user\_id):**  
Функция для отслеживания уникальных пользователей. Она проверяет, есть ли файл "users.txt", в котором сохраняются идентификаторы пользователей, и добавляет нового пользователя в файл, если его там нет.  
**get\_user\_count():**  
Функция для подсчёта количества уникальных пользователей, считывая количество строк в файле "users.txt".  
**get\_all\_users():**  
Функция возвращает список всех уникальных пользователей, загружая строки из файла "users.txt" в список.  
**is\_user\_blocked(user\_id):**  
Проверяет, заблокирован ли пользователь. Функция проверяет, есть ли пользователь в `user_status` и не истекло ли время блокировки. Возвращает `True`, если пользователь еще заблокирован.  
**block\_user(user\_id, duration):**  
Блокирует пользователя на заданное время, добавляя текущее время плюс длительность блокировки в `user_status` для этого пользователя.  
**notify\_users(application, message):**  
Асинхронная функция для отправки уведомления всем пользователям. Она перебирает список пользователей и отправляет каждому сообщение.  
**shutdown(update: Update, context):**  
Асинхронная функция для завершения работы бота. Если команду запускает администратор, бот уведомляет всех пользователей о временной остановке. Если нет, бот отправляет ответ об отсутствии прав на выполнение этой команды.  
**handle\_message(update: Update, context):**  
Асинхронная функция для обработки сообщений от пользователя.  
**start(update: Update, context):**  
Асинхронная функция для обработки команды `/start`, отправляющая приветственное сообщение и отображающая количество пользователей.  
**notify\_on\_start(application):**  
Асинхронная функция, которая уведомляет всех пользователей о том, что бот снова активен и готов принимать запросы.  
**Основной блок в `__main__`:**  
Инициализирует бота, запускает уведомление о старте, добавляет обработчики команд и начинает работу с использованием метода `run_polling()`, ожидая новые сообщения.

Image\_generator.py  
**load\_text\_processing\_model():**  
Загружает модель для перевода текста с русского на английский. Функция использует библиотеку `transformers` для создания конвейера перевода с использованием модели `"Helsinki-NLP/opus-mt-ru-en"` и GPU (указание `device=0`). Она логирует процесс загрузки, а затем возвращает модель.  
**preprocess\_text(prompt, translation\_model):**  
Принимает текстовый запрос (`prompt`) и модель перевода. Функция переводит текст с русского на английский с помощью модели, логирует исходный и переведённый текст, и возвращает переведённый текст.  
**load\_model():**  
Загружает модель для генерации изображений, используя `StableDiffusionPipeline` из библиотеки `diffusers` с настройкой `torch_dtype=torch.float16` для экономии видеопамяти. Модель загружается в GPU (`pipe.to("cuda")`). Функция логирует успешную загрузку модели и возвращает её.  
**generate\_image(prompt, model):**  
Принимает текстовый запрос (`prompt`) и модель для генерации изображений. Функция создаёт изображение по запросу, используя GPU. Сгенерированное изображение сохраняется как `generated_image.png`, после чего путь к файлу возвращается.

Convert\_original\_stable\_diffusion\_to\_diffusers

В этом файле находится скрипт для конвертации контрольных точек (чекпоинтов) модели Stable Diffusion в формат, поддерживаемый библиотекой Diffusers. Вот описание функций и аргументов:

1. **Аргументы командной строки (parser.add\_argument):**  
   Используются для настройки параметров запуска. Аргументы включают:

* **checkpoint\_path**: путь к файлу с контрольной точкой для конвертации.  
* **original\_config\_file** и **config\_files**: пути к YAML-файлам конфигурации.  
* **num\_in\_channels**: число входных каналов.  
* **scheduler\_type**: тип планировщика (`'pndm'`, `'lms'`, и др.).  
* **pipeline\_type**: тип конвейера (например, `FrozenOpenCLIPEmbedder`).  
* **image\_size**: размер изображений.  
* **prediction\_type**: тип предсказания (`'epsilon'` или `'v_prediction'`).  
* **extract\_ema**: если активировано, извлекаются EMA-веса.  
* **device**: устройство для использования (например, `cuda:0`).  
* **stable\_unclip**: указывает, что это модель unCLIP (`txt2img` или `img2img`).  
* **clip\_stats\_path**: путь к файлу статистики для unCLIP-модели.  
* **controlnet**: флаг для моделей ControlNet.  
* **half**: сохраняет веса в половинной точности (`float16`).

2. **Импорт класса `pipeline_class`:**  
   Если указан `pipeline_class_name`, он импортируется из библиотеки `diffusers`.  
3. **Функция `download_from_original_stable_diffusion_ckpt`:**  
   Выполняет загрузку и конвертацию контрольной точки. Параметры из аргументов передаются в эту функцию, которая конвертирует модель для работы в формате, поддерживаемом библиотекой Diffusers.  
4. **Сохранение модели:**  
   Конечная модель сохраняется по пути, указанному в аргументе `dump_path`. Если активирован флаг `controlnet`, сохраняется только модель ControlNet.

### 

### **АРХИТЕКТУРА**

### **Модель для перевода текста (Helsinki-NLP/opus-mt-ru-en)**

Архитектура: **Transformer**

* **Описание**: Модель перевода `Helsinki-NLP/opus-mt-ru-en` основана на архитектуре **Transformer**, разработанной Google. Эта архитектура широко используется для задач обработки естественного языка (NLP), включая перевод.  
* **Особенности**:  
  * Модель использует механизмы **внимания** (Attention), что позволяет ей эффективно находить контексты между словами в предложении.  
  * **Многослойные энкодеры и декодеры** позволяют модели лучше понимать структуру языка и выполнять точный перевод.  
* **Преимущества для проекта**: Transformer хорошо работает на задачах перевода, особенно при работе с языковыми парами. Благодаря этому бот может обрабатывать русские запросы и переводить их на английский, обеспечивая лучшую совместимость с моделью генерации изображений.

### **2\. Модель для генерации изображений (Stable Diffusion v1.5)**

Архитектура: **Диффузионная модель**

* **Описание**: **Stable Diffusion** основана на архитектуре диффузионной модели, которая выполняет генерацию изображений путём постепенного добавления и удаления шума.  
* **Принцип работы**:

  Модель сначала добавляет случайный шум к изображению, а затем обучается на обратном процессе — удалении шума, чтобы восстановить изображение из шума. Это позволяет модели генерировать новые изображения, которые соответствуют заданному текстовому описанию.

  Использует **U-Net** для работы с изображениями, а **Variational Autoencoder (VAE)** — для представления изображения в скрытом пространстве.

* **Особенности**:

  **Встраивание текста (Text Embedding)**: для интерпретации текстовых запросов модель использует сжатое представление (embedding) текста, позволяя генерировать изображение на основе текстового описания.

  **Вариации**: Stable Diffusion позволяет генерировать изображения высокого качества, добавляя мелкие детали и обеспечивая соответствие тексту.

* **Преимущества для проекта**: Диффузионные модели, такие как Stable Diffusion, отлично подходят для генерации сложных и реалистичных изображений. Они обучены на больших наборах данных и могут создавать изображения, которые соответствуют разнообразным текстовым запросам.

### **Итоговая архитектура**

* **Комбинированная архитектура Transformer \+ Диффузионная модель**:

  **Transformer** используется для перевода текста с русского на английский, что улучшает работу бота для русскоязычных пользователей.

  **Диффузионная модель** Stable Diffusion отвечает за создание изображения по запросу пользователя, используя предварительно обработанный текст.

**Причина появления чёрного квадрата при ненормативной лексике**

При вводе ненормативных слов в текстовом запросе к боту появляется чёрный квадрат вместо изображения. Это происходит из\-за встроенного NSFW-фильтра (фильтра нежелательного контента) в модели Stable Diffusion. Этот фильтр автоматически блокирует генерацию изображений, которые могут считаться неуместными или потенциально вредными. В случае таких запросов модель просто возвращает чёрное изображение, сигнализируя о невозможности обработки данного текста. NSFW-фильтр помогает поддерживать безопасное использование модели и предотвращает генерацию контента, не соответствующего политике безопасности платформы.

Эти модели загружаются и сохраняются в кэше автоматически при первом использовании, что позволяет оптимизировать производительность и снижает задержки, связанные с повторной загрузкой моделей из интернета.

### **Антиспам-система**

Антиспам-система бота предотвращает спам и чрезмерные запросы от пользователей, защищая сервер от перегрузки. Эта система управляет статусом каждого пользователя и ограничивает частоту запросов.

Сначала бот отслеживает статус пользователей, сохраняет информацию о каждом из них и добавляет их в переменную `user_status`. Этот статус хранит время, до которого пользователь заблокирован от новых запросов.

Когда пользователь отправляет запрос, бот проверяет, не находится ли он в списке заблокированных. Если пользователь заблокирован, бот не обрабатывает его запрос и отправляет сообщение с предупреждением о временной блокировке. Эта блокировка активируется каждый раз после отправки пользователем запроса и длится 10 секунд.

Система использует две основные функции:

* `block_user` устанавливает временную блокировку, записывая текущее время плюс длительность блокировки.  
* `is_user_blocked` проверяет, заблокирован ли пользователь, сравнивая текущее время с временем окончания блокировки.

Если пользователь пытается отправить запрос до завершения блокировки, бот отправляет сообщение, уведомляя о необходимости подождать перед следующим запросом: «Неприятно когда спамят? Держи обратно\!»

Антиспам-система защищает бота от перегрузок, обеспечивая стабильную работу для всех пользователей. Эта простая и эффективная система контролирует поток запросов и оптимизирует использование ресурсов.

**Источники**  
**GitHub Discussions** — проблемы черных квадратов и фильтрации контента в Stable Diffusion, а также советы по настройке параметров:

* [GitHub Issue \#23 on Stable Diffusion black square output](https://github.com/lshqqytiger/stable-diffusion-webui-amdgpu/issues/23)​  
* [GitHub Discussion on blank images](https://github.com/huggingface/diffusers/issues/1614) — объясняет случаи, когда чёрные изображения возникают из\-за настройки autocast и других параметров, что может быть связано с управлением ресурсами и фильтрацией​  


**Stable Diffusion Online FAQ** — объясняет работу NSFW-фильтра, который может блокировать генерацию контента при использовании ненормативной лексики и нежелательных запросов:

* [Stable Diffusion Profanity Prompts](https://stablediffusionweb.com/prompts/profanity)​  

**Hugging Face Documentation** — официальная документация по библиотеке `diffusers`, используемой для реализации моделей генерации изображений и загрузки моделей, таких как Stable Diffusion:

* Hugging Face Diffusers Documentation — подробно описывает архитектуру и использование моделей в проектах.

**МОДЕЛИ ПРОЕКТА:**

* **Официальная страница на Hugging Face: Helsinki-NLP/opus-mt-ru-en**  
* **Официальная страница на Hugging Face: runwayml/stable-diffusion-v1-5**